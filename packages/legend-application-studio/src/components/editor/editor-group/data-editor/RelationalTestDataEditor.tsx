/**
 * Copyright (c) 2020-present, Goldman Sachs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { observer } from 'mobx-react-lite';
import { useState, useRef } from 'react';
import {
  BlankPanelPlaceholder,
  PanelContent,
  PanelHeader,
  PlusIcon,
  TimesIcon,
  LockIcon,
} from '@finos/legend-art';
import { guaranteeNonNullable } from '@finos/legend-shared';
import type { RelationalTestDataState } from '../../../../stores/editor/editor-state/element-editor-state/data/EmbeddedDataState.js';
import { useApplicationNavigationContext } from '@finos/legend-application';
import { LEGEND_STUDIO_APPLICATION_NAVIGATION_CONTEXT_KEY } from '../../../../__lib__/LegendStudioApplicationNavigationContext.js';

const DATA_TYPES = ['VARCHAR', 'INTEGER', 'DECIMAL', 'DATE', 'BOOLEAN'];

export const RelationalTestDataEditor = observer(
  (props: { dataState: RelationalTestDataState; isReadOnly: boolean }) => {
    const { dataState, isReadOnly } = props;
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [exportFormat, setExportFormat] = useState<'json' | 'csv' | 'sql'>(
      'json',
    );

    useApplicationNavigationContext(
      LEGEND_STUDIO_APPLICATION_NAVIGATION_CONTEXT_KEY.EMBEDDED_DATA_RELATIONAL_EDITOR,
    );

    const addColumn = (): void => {
      if (!isReadOnly) {
        const columnName = `column_${dataState.columns.length + 1}`;
        dataState.addColumn(columnName, 'VARCHAR');
      }
    };

    const removeColumn = (index: number): void => {
      if (!isReadOnly) {
        dataState.removeColumn(index);
      }
    };

    const updateColumn = (
      index: number,
      field: 'name' | 'type',
      value: string,
    ): void => {
      if (!isReadOnly) {
        const column = dataState.columns[index];
        if (column) {
          if (field === 'name') {
            dataState.updateColumn(index, value, column.type);
          } else {
            dataState.updateColumn(index, column.name, value);
          }
        }
      }
    };

    const addRow = (): void => {
      if (!isReadOnly) {
        dataState.addRow();
      }
    };

    const removeRow = (index: number): void => {
      if (!isReadOnly) {
        dataState.removeRow(index);
      }
    };

    const updateCellValue = (
      rowIndex: number,
      columnName: string,
      value: string,
    ): void => {
      if (!isReadOnly) {
        dataState.updateRow(rowIndex, columnName, value);
      }
    };

    const handleFileUpload = (
      event: React.ChangeEvent<HTMLInputElement>,
    ): void => {
      const file = event.target.files?.[0];
      if (file && file.type === 'text/csv') {
        const reader = new FileReader();
        reader.onload = (e) => {
          const csvContent = e.target?.result as string;
          if (csvContent) {
            dataState.importCSV(csvContent);
          }
        };
        reader.readAsText(file);
      }
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    };

    const exportData = (): void => {
      let content = '';
      let filename = '';
      let mimeType = '';

      switch (exportFormat) {
        case 'json':
          content = dataState.exportJSON();
          filename = 'test_data.json';
          mimeType = 'application/json';
          break;
        case 'csv':
          content = dataState.exportCSV();
          filename = 'test_data.csv';
          mimeType = 'text/csv';
          break;
        case 'sql':
          content = dataState.exportSQL();
          filename = 'test_data.sql';
          mimeType = 'text/sql';
          break;
        default:
          content = dataState.exportJSON();
          filename = 'test_data.json';
          mimeType = 'application/json';
          break;
      }

      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    return (
      <div className="panel relational-test-data-editor">
        <PanelHeader>
          <div className="panel__header__title">
            {isReadOnly && (
              <div className="panel__header__lock">
                <LockIcon />
              </div>
            )}
            <div className="panel__header__title__label">
              {dataState.label()}
            </div>
          </div>
        </PanelHeader>
        <PanelContent>
          {dataState.columns.length === 0 ? (
            <BlankPanelPlaceholder
              text="Add columns to define your test data structure"
              onClick={addColumn}
              clickActionType="add"
              tooltipText="Add Column"
              disabled={isReadOnly}
            />
          ) : (
            <div className="relational-test-data-editor__content">
              <div className="relational-test-data-editor__columns">
                <div className="relational-test-data-editor__section-header">
                  <div className="relational-test-data-editor__section-title">
                    Column Definitions
                  </div>
                  <button
                    className="btn btn--dark btn--sm"
                    onClick={addColumn}
                    disabled={isReadOnly}
                    title="Add Column"
                  >
                    <PlusIcon />
                    Add Column
                  </button>
                </div>
                <div className="relational-test-data-editor__columns-grid">
                  {dataState.columns.map((column, index) => (
                    <div
                      key={`column-${guaranteeNonNullable(index)}`}
                      className="relational-test-data-editor__column-row"
                    >
                      <input
                        className="relational-test-data-editor__column-input"
                        type="text"
                        value={column.name}
                        onChange={(e) =>
                          updateColumn(index, 'name', e.target.value)
                        }
                        placeholder="Column Name"
                        disabled={isReadOnly}
                      />
                      <select
                        className="relational-test-data-editor__column-select"
                        value={column.type}
                        onChange={(e) =>
                          updateColumn(index, 'type', e.target.value)
                        }
                        disabled={isReadOnly}
                      >
                        {DATA_TYPES.map((type) => (
                          <option key={type} value={type}>
                            {type}
                          </option>
                        ))}
                      </select>
                      <button
                        className="btn--icon btn--dark btn--sm"
                        onClick={() => removeColumn(index)}
                        disabled={isReadOnly}
                        title="Remove Column"
                      >
                        <TimesIcon />
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="relational-test-data-editor__data">
                <div className="relational-test-data-editor__section-header">
                  <div className="relational-test-data-editor__section-title">
                    Test Data ({dataState.rows.length} rows)
                  </div>
                </div>
                {dataState.rows.length === 0 ? (
                  <div className="relational-test-data-editor__empty-data">
                    <div className="relational-test-data-editor__empty-text">
                      No test data rows. Click &quot;Add Row&quot; to start
                      entering data.
                    </div>
                  </div>
                ) : (
                  <div className="relational-test-data-editor__data-grid">
                    <div className="relational-test-data-editor__data-header">
                      {dataState.columns.map((column) => (
                        <div
                          key={column.name}
                          className="relational-test-data-editor__data-header-cell"
                        >
                          {column.name}
                          <span className="relational-test-data-editor__data-type">
                            ({column.type})
                          </span>
                        </div>
                      ))}
                      <div className="relational-test-data-editor__data-header-cell relational-test-data-editor__data-actions">
                        Actions
                      </div>
                    </div>
                    {dataState.rows.map((row, rowIndex) => (
                      <div
                        key={`row-${guaranteeNonNullable(rowIndex)}`}
                        className="relational-test-data-editor__data-row"
                      >
                        {dataState.columns.map((column) => (
                          <div
                            key={column.name}
                            className="relational-test-data-editor__data-cell"
                          >
                            <input
                              type="text"
                              value={row[column.name] ?? ''}
                              onChange={(e) =>
                                updateCellValue(
                                  rowIndex,
                                  column.name,
                                  e.target.value,
                                )
                              }
                              disabled={isReadOnly}
                              className="relational-test-data-editor__data-input"
                            />
                          </div>
                        ))}
                        <div className="relational-test-data-editor__data-cell relational-test-data-editor__data-actions">
                          <button
                            className="btn--icon btn--dark btn--sm"
                            onClick={() => removeRow(rowIndex)}
                            disabled={isReadOnly}
                            title="Remove Row"
                          >
                            <TimesIcon />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <div className="relational-test-data-editor__export-controls">
                  <button
                    className="btn btn--dark btn--sm"
                    onClick={addRow}
                    disabled={isReadOnly || dataState.columns.length === 0}
                    title="Add Row"
                  >
                    <PlusIcon />
                    Add Row
                  </button>

                  <button
                    className="btn btn--dark btn--sm"
                    onClick={() => {
                      if (
                        window.confirm(
                          'Are you sure you want to clear all test data?',
                        )
                      ) {
                        dataState.clearAllData();
                      }
                    }}
                    disabled={isReadOnly || dataState.rows.length === 0}
                    title="Clear All Data"
                  >
                    Clear All Data
                  </button>

                  <div className="relational-test-data-editor__export-format">
                    <label htmlFor="exportFormat">Export as:</label>
                    <select
                      id="exportFormat"
                      value={exportFormat}
                      onChange={(e) =>
                        setExportFormat(
                          e.target.value as 'json' | 'csv' | 'sql',
                        )
                      }
                      disabled={isReadOnly}
                      className="relational-test-data-editor__export-select"
                    >
                      <option value="json">JSON</option>
                      <option value="csv">CSV</option>
                      <option value="sql">SQL INSERT</option>
                    </select>
                    <button
                      className="btn btn--dark btn--sm"
                      onClick={exportData}
                      disabled={isReadOnly}
                      title={`Export as ${exportFormat.toUpperCase()}`}
                    >
                      Export
                    </button>
                  </div>

                  <div className="relational-test-data-editor__import-controls">
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".csv"
                      onChange={handleFileUpload}
                      style={{ display: 'none' }}
                      disabled={isReadOnly}
                    />
                    <button
                      className="btn btn--dark btn--sm"
                      onClick={() => fileInputRef.current?.click()}
                      disabled={isReadOnly}
                      title="Upload a file of CSV"
                    >
                      Upload a file of CSV
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </PanelContent>
      </div>
    );
  },
);
